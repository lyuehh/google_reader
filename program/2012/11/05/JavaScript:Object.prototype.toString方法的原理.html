<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>JavaScript:Object.prototype.toString方法的原理</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/google_reader/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/google_reader/css/main.css">

    </head>
    <body>

        <div class="container">
          <div class="site">
            <div class="header">
              <h1 class="title"><a href="/google_reader/">Google Reader</a></h1>
              <a class="extra" href="/google_reader/">home</a>
            </div>

                <h2>JavaScript:Object.prototype.toString方法的原理</h2>
<p class="meta">2012-11-05 18:55</p>

<div class="post">
<h2>JavaScript:Object.prototype.toString方法的原理</h2>

<h3>by 紫云飞</h3>

<h3>at 2012-11-05 10:55:00</h3>

<h3>original <a href="http://www.cnblogs.com/ziyunfei/archive/2012/11/05/2754156.html">http://www.cnblogs.com/ziyunfei/archive/2012/11/05/2754156.html</a></h3>

<p>在JavaScript中,想要判断某个对象值属于哪种内置类型,最靠谱的做法就是通过Object.prototype.toString方法.</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px"><span style="color:#0000ff">var</span> arr =<span style="color:#000000"> [];<br>console.log(Object.prototype.toString.call(arr))  </span><span style="color:#008000">//"<span>[object Array]</span>"</span></div>


<p>本文要讲的就是,toString方法是如何做到这一点的,原理是什么.</p>


<p><strong>ECMAScript 3</strong></p>


<p>在<a href="http://bclary.com/2004/11/07/">ES3</a>中,Object.prototype.toString方法的规范如下:</p>


<blockquote><dl><dt>15.2.4.2 Object.prototype.toString()</dt><dd><p>在<strong><tt>toString</tt></strong>方法被调用时,会执行下面的操作步骤:</p><p>1. 获取this对象的[[Class]]属性的值.</p><p>2. 计算出三个字符串<strong><tt>"[object ",</tt></strong> 第一步的操作结果Result(1), 以及 <strong><tt>"]"</tt></strong><tt>连接后的新字符串.</tt></p><p>3. 返回第二步的操作结果Result(2).</p></dd></dl></blockquote>


<p>[[Class]]是一个内部属性,所有的对象(原生对象和宿主对象)都拥有该属性.在规范中,[[Class]]是这么定义的</p>


<table><thead><tr><th>内部属性</th><th>描述</th></tr></thead><tbody><tr><td><a name="_Class_"></a>[[Class]]</td><td>一个字符串值,表明了该对象的类型.</td></tr></tbody></table>


<p>然后给了一段解释:</p>


<blockquote><p>所有内置对象的[[Class]]属性的值是由本规范定义的.所有宿主对象的[[Class]]属性的值可以是任意值,甚至可以是内置对象使用过的[[Class]]属性的值.[[Class]]属性的值可以用来判断一个原生对象属于哪种内置类型.需要注意的是,除了通过<strong><tt>Object.prototype.toString</tt></strong>方法之外,本规范没有提供任何其他方式来让程序访问该属性的值(查看 15.2.4.2).</p></blockquote>


<p>也就是说,把Object.prototype.toString方法返回的字符串,去掉前面固定的<strong><tt>"[object "</tt></strong>和后面固定的<strong>"]",</strong>就是内部属性[[class]]的值,也就达到了判断对象类型的目的.jQuery中的工具方法$.type(),就是干这个的.</p>


<p>在ES3中,规范文档并没有总结出[[class]]内部属性一共有几种,不过我们可以自己统计一下,原生对象的[[class]]内部属性的值一共有10种.分别是:<code>"Array"</code>, <code>"Boolean"</code>, <code>"Date"</code>, <code>"Error"</code>, <code>"Function"</code><code></code>, <code>"Math"</code>, <code>"Number"</code>, <code>"Object"</code>, <code>"RegExp"</code>, <code>"String".</code></p>


<p><strong>ECMAScript 5</strong></p>


<p>在<a href="http://ecma-international.org/ecma-262/5.1">ES5.1</a>中,除了规范写的更详细一些以外,Object.prototype.toString方法和[[class]]内部属性的定义上也有一些变化,Object.prototype.toString方法的规范如下:</p>


<blockquote><p><strong><span>15.2.4.2</span> Object.prototype.toString ( )</strong></p><p>在<strong><tt>toString</tt></strong>方法被调用时,会执行下面的操作步骤:</p><ol><li>如果<strong>this</strong>的值为<strong>undefined</strong>,则返回<code>"[object Undefined]"</code>.</li><li>如果<strong>this</strong>的值为<strong>null</strong>,则返回<code>"[object Null]"</code>.</li><li>让<em>O</em>成为调用ToObject(<strong>this)</strong>的结果.</li><li>让<em>class</em>成为<em>O</em>的内部属性[[Class]]的值.</li><li>返回三个字符串<strong><tt>"[object ",</tt></strong> <em>class</em>, 以及 <strong><tt>"]"</tt></strong><tt>连接后的新字符串</tt><code></code>.</li></ol></blockquote>


<p>可以看出,比ES3多了1,2,3步.第1,2步属于新规则,比较特殊,因为"<code>Undefined"</code>和"<code>Null"</code>并不属于[[class]]属性的值,需要注意的是,这里和严格模式无关(大部分函数在严格模式下,this的值才会保持undefined或null,非严格模式下会自动成为全局对象).第3步并不算是新规则,因为在ES3的引擎中,也都会在这一步将三种原始值类型转换成对应的包装对象,只是规范中没写出来.ES5中,[[Class]]属性的解释更加详细:</p>


<blockquote><p>所有内置对象的[[Class]]属性的值是由本规范定义的.所有宿主对象的[[Class]]属性的值可以是除了"Arguments", "Array", "Boolean", "Date", "Error", "Function", "JSON", "Math", "Number", "Object", "RegExp", "String"之外的的任何字符串.[[Class]]内部属性是引擎内部用来判断一个对象属于哪种类型的值的.需要注意的是,除了通过<strong><tt>Object.prototype.toString</tt></strong>方法之外,本规范没有提供任何其他方式来让程序访问该属性的值(查看 15.2.4.2).</p></blockquote>


<p>和ES3对比一下,第一个差别就是[[class]]内部属性的值多了两种,成了12种,一种是arguments对象的[[class]]成了"Arguments",而不是以前的"Object",还有就是多个了全局对象JSON,它的[[class]]值为"JSON".第二个差别就是,宿主对象的[[class]]内部属性的值,不能和这12种值冲突,不过在支持ES3的浏览器中,貌似也没有发现哪些宿主对象故意使用那10个值.</p>


<p><strong>ECMAScript 6</strong></p>


<p><a href="http://people.mozilla.org/~jorendorff/es6-draft.html">ES6</a>目前还只是工作草案,但能够肯定的是,<strong>[[class]]内部属性没有了</strong>,取而代之的是另外一个内部属性[[NativeBrand]].[[NativeBrand]]属性是这么定义的:</p>


<blockquote><table><tbody><tr><th style="border-bottom:1px solid #000000;border-left:1px solid #000000;border-top:2px solid #000000">内部属性</th><th style="border-bottom:1px solid #000000;border-top:2px solid #000000">属性值</th><th style="border-bottom:1px solid #000000;border-right:1px solid #000000;border-top:2px solid #000000">描述</th></tr><tr><td>[[NativeBrand]]</td><td>枚举NativeBrand的一个成员.</td><td>该属性的值对应一个标志值(tag value),可以用来区分原生对象的类型.</td></tr></tbody></table></blockquote>


<p> [[NativeBrand]]属性的解释:</p>


<blockquote><p>[[NativeBrand]]内部属性用来识别某个原生对象是否为符合本规范的某一种特定类型的对象.[[NativeBrand]]内部属性的值为下面这些枚举类型的值中的一个:NativeFunction, NativeArray, StringWrapper, BooleanWrapper, NumberWrapper, NativeMath, NativeDate, NativeRegExp, NativeError, NativeJSON, NativeArguments, NativePrivateName.[[NativeBrand]]内部属性仅用来区分区分特定类型的ECMAScript原生对象.只有在表10中明确指出的对象类型才有[[NativeBrand]]内部属性.</p><p>表10 — [[NativeBrand]]内部属性的值</p><table><tbody><tr><th style="border-bottom:1px solid #000000;border-left:1px solid #000000;border-top:2px solid #000000">属性值</th><th style="border-bottom:1px solid #000000;border-top:2px solid #000000">对应类型</th></tr><tr><td>NativeFunction</td><td>Function objects</td></tr><tr><td>NativeArray</td><td>Array objects</td></tr><tr><td>StringWrapper</td><td>String objects</td></tr><tr><td>BooleanWrapper</td><td>Boolean objects</td></tr><tr><td>NumberWrapper</td><td>Number objects</td></tr><tr><td>NativeMath</td><td>The Math object</td></tr><tr><td>NativeDate</td><td>Date objects</td></tr><tr><td>NativeRegExp</td><td>RegExp objects</td></tr><tr><td>NativeError</td><td>Error objects</td></tr><tr><td>NativeJSON</td><td>The JSON object</td></tr><tr><td>NativeArguments</td><td>Arguments objects</td></tr><tr><td>NativePrivateName</td><td>Private Name objects</td></tr></tbody></table></blockquote>


<p>可见,和[[class]]不同的是,并不是每个对象都拥有[[NativeBrand]].同时,Object.prototype.toString方法的规范也改成了下面这样:</p>


<blockquote><p><strong><span>15.2.4.2</span> Object.prototype.toString ( )</strong></p><p>在<strong><tt>toString</tt></strong>方法被调用时,会执行下面的操作步骤:</p><ol><li>如果<strong>this</strong>的值为<strong>undefined</strong>,则返回<code>"[object Undefined]"</code>.</li><li><code></code>如果<strong>this</strong>的值为<strong>null</strong>,则返回<code>"[object Null]"</code>.</li><li>让<em>O</em>成为调用ToObject(<strong>this)</strong>的结果.</li><li>如果<em>O</em>有[[NativeBrand]]内部属性,让<em>tag</em>成为表29中对应的值.</li><li>否则<ol><li>让<em>hasTag</em>成为调用<em>O</em>的[[HasProperty]]内部方法后的结果,参数为@@toStringTag.</li><li>如果<em>hasTag</em>为<strong>false</strong>,则让<em>tag</em>为<code>"Object"</code>.</li><li>否则,<ol><li>让<em>tag</em>成为调用<em>O</em>的[[Get]]内部方法后的结果,参数为@@toStringTag.</li><li>如果<em>tag</em>是一个abrupt completion,则让<em>tag</em>成为NormalCompletion(<code>"???"</code>).</li><li>让<em>tag</em>成为<em>tag</em>.[[value]].</li><li>如果Type(<em>tag</em>)不是字符串,则让<em>tag成为</em><code>"???"</code>.</li><li>如果<em>tag</em>的值为<code>"Arguments"</code>, <code>"Array"</code>, <code>"Boolean"</code>, <code>"Date"</code>, <code>"Error"</code>, <code>"Function"</code>, <code>"JSON"</code>, <code>"Math"</code>, <code>"Number"</code>, <code>"Object"</code>, <code>"RegExp"</code>,<code>或者"String"中的任一个,则让</code><em>tag</em>成为字符串<code>"~"和</code><em>tag</em>当前的值连接后的结果.</li></ol></li></ol></li><li>返回三个字符串"[object ", tag, and "]"<tt>连接后的新字符串</tt><code></code>.</li></ol><p>表29 — [[NativeBrand]] 标志值</p><table><tbody><tr><th style="border-width:1px;border-style:solid;border-color:black #000000 black black">[[NativeBrand]]值</th><th style="border-width:1px;border-style:solid;border-color:black #000000 black black">标志值</th></tr><tr><td style="border-width:1px;border-style:solid;border-color:black #000000 black black">NativeFunction</td><td style="border-width:1px;border-style:solid;border-color:black #000000 black black"><code>"Function"</code></td></tr><tr><td style="border-width:1px;border-style:solid;border-color:black #000000 black black">NativeArray</td><td style="border-width:1px;border-style:solid;border-color:black #000000 black black"><code>"Array"</code></td></tr><tr><td style="border-width:1px;border-style:solid;border-color:black #000000 black black">StringWrapper</td><td style="border-width:1px;border-style:solid;border-color:black #000000 black black"><code>"String"</code></td></tr><tr><td style="border-width:1px;border-style:solid;border-color:black #000000 black black">BooleanWrapper</td><td style="border-width:1px;border-style:solid;border-color:black #000000 black black"><code>"Boolean"</code></td></tr><tr><td style="border-width:1px;border-style:solid;border-color:black #000000 black black">NumberWrapper</td><td style="border-width:1px;border-style:solid;border-color:black #000000 black black"><code>"Number"</code></td></tr><tr><td style="border-width:1px;border-style:solid;border-color:black #000000 black black">NativeMath</td><td style="border-width:1px;border-style:solid;border-color:black #000000 black black"><code>"Math"</code></td></tr><tr><td style="border-width:1px;border-style:solid;border-color:black #000000 black black">NativeDate</td><td style="border-width:1px;border-style:solid;border-color:black #000000 black black"><code>"Date"</code></td></tr><tr><td style="border-bottom:1px solid black;border-left:1px solid black;border-right:1px solid #000000">NativeRegExp</td><td style="border-bottom:1px solid black;border-right:1px solid black"><code>"RegExp"</code></td></tr><tr><td style="border-width:1px;border-style:solid;border-color:black #000000 black black">NativeError</td><td style="border-bottom:1px solid black;border-right:1px solid black"><code>"Error"</code></td></tr><tr><td style="border-width:1px;border-style:solid;border-color:black #000000 black black">NativeJSON</td><td style="border-bottom:1px solid black;border-right:1px solid black"><code>"JSON"</code></td></tr><tr><td style="border-width:1px;border-style:solid;border-color:black #000000 black black">NativeArguments</td><td style="border-bottom:1px solid black;border-right:1px solid black"><code>"Arguments"</code></td></tr></tbody></table><div> </div></blockquote>


<p>可以看到,在规范上有了很大的变化,不过对于普通用户来说,貌似感觉不到.</p>


<p>也许你发现了,ES6里的新类型Map,Set等,都没有在表29中.它们在执行toString方法的时候返回的是什么?</p>


<div style="background-color:#f5f5f5;border:1px solid #cccccc;padding:10px">console.log(Object.prototype.toString.call(Map()))   <span style="color:#008000">//</span><span style="color:#008000">"[object Map]"<br><br></span>console.log(Object.prototype.toString.call(Set()))   <span style="color:#008000">//</span><span style="color:#008000">"[object Set]"</span></div>


<p>其中的字符串"Map"是怎么来的呢:</p>


<blockquote><p><strong>15.14.5.13</strong> Map.prototype.@@toStringTag</p><p>@@toStringTag 属性的初始值为字符串<strong>"<span style="font-family:monospace">Map</span>"</strong>.</p></blockquote>


<p>由于ES6的规范还在制定中,各种相关规定都有可能改变,所以如果想了解更多细节.看看下面这两个链接,现在只需要知道的是:[[class]]没了,使用了更复杂的机制.</p>


<p><a href="http://stackoverflow.com/questions/13151643/access-nativebrand-class-in-es6-ecmascript-6">http://stackoverflow.com/questions/13151643/access-nativebrand-class-in-es6-ecmascript-6</a></p>


<p><a href="https://mail.mozilla.org/pipermail/es-discuss/2012-June/023676.html">https://mail.mozilla.org/pipermail/es-discuss/2012-June/023676.html</a></p>


<p><img src="http://www.cnblogs.com/ziyunfei/aggbug/2754156.html?type=1" width="1" height="1" alt=""><p><a href="http://www.cnblogs.com/ziyunfei/archive/2012/11/05/2754156.html">本文链接</a></p></p>

</div>


            <div class="footer">
              <div class="contact">
                <p>
                  Your Name<br />
                  What You Are<br />
                  your@email.com
                </p>
              </div>
              <div class="contact">
                <p>
                  <a href="http://github.com/lyuehh/">github.com/lyuehh</a><br />
                  <a href="http://twitter.com/lyuehh/">twitter.com/lyuehh</a><br />
                </p>
              </div>
            </div>
          </div>
        </div> <!-- /container -->

    </body>
</html>
